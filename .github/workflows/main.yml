name: Python CI with pipenv

on:
  pull_request: {}
  push:
    branches:
      - 'main'
      - 'feature/**'
    paths-ignore:
      - '**.md'
      - '_config.yml'
      - '**.tweet'

jobs:
  static-code-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/project-environment-setup
      - run: pipenv run isort --recursive --diff .
      - run: pipenv run black --check .
      - run: pipenv run flake8
      - run: pipenv run mypy
      - name: Python Tests with pytest
        run: LOG_LEVEL=INFO pipenv run pytest --cov --cov-fail-under=90 --capture=no --log-cli-level=INFO -n auto
  pyinstaller-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/project-environment-setup
      - name: Build Application Executable Package with PyInstaller
        run: |
          pipenv run pyinstaller --windowed --noconsole \
            --add-data "setup.cfg:." \
            --add-data "pysimplegui_boilerplate/resources/*:pysimplegui_boilerplate/resources" \
            --name pysimplegui_boilerplate-main \
            --clean --noconfirm pysimplegui_boilerplate/__main__.py
      - name: Display Built Artifacts
        run: |
          du -s -h *
#      - name: Smoke Test PyInstaller Application
#        run: ./dist/multithread_and_thread_pool_usage/multithread_and_thread_pool_usage
